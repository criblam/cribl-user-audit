{
  "schedule": {
    "enabled": false,
    "cronSchedule": "0 0 * * *",
    "tz": "UTC",
    "keepLastN": 2
  },
  "name": "User Audit",
  "elements": [
    {
      "config": {},
      "search": {
        "type": "inline",
        "query": "dataset=\"user_audit\" cribl_api=\"/product/{id}/users\" \n| project _time, user_id=id, email, username, roles | sort by user_id asc, _time asc                            \n| extend time_diff=datetime_diff('minute',_time,prev(_time)), job=row_cumsum(time_diff)\n| summarize job_time=format_datetime(max(_time), 'yy-MM-dd HH:mm'), all_roles=values(roles) by user_id, email, username, job\n| mv-expand all_roles | mv-expand all_roles | sort by all_roles asc | summarize roles=values(all_roles) by user_id, email, username, job_time | sort by user_id asc, job_time asc\n| extend role_updated_at=iif(prev(roles)!=roles and prev(user_id)!=user_id, job_time, prev(role_updated_at)) \n| eventstats latest_job=max(job_time) by user_id | where job_time==latest_job\n| project user_id, email, username=tolower(username), roles, role_updated_at \n| join kind=leftouter (\n    dataset=\"user_audit\" cribl_api=\"/teams/{id}/users\" \n    | project _time, user_id, team_id | sort by user_id asc, _time asc, team_id asc\n    | extend time_diff=datetime_diff('minute',_time,prev(_time)), job=row_cumsum(time_diff)\n    | summarize job_time=format_datetime(max(_time), 'yy-MM-dd HH:mm') by user_id, team_id, job\n    | eventstats latest_job=max(job_time) by user_id, team_id | where job_time==latest_job\n    | join kind=leftouter (\n        dataset=\"user_audit\" cribl_api=\"/teams\"\n        | project _time, team_id=id, roles | sort by team_id asc, _time asc\n        | extend time_diff=datetime_diff('minute',_time,prev(_time)), job=row_cumsum(time_diff)\n        | summarize job_time=format_datetime(max(_time), 'yy-MM-dd HH:mm'), roles=values(roles) by team_id, job\n        | eventstats latest_job=max(job_time) by team_id | where job_time==latest_job\n        | mv-expand roles | project team_id, roles\n        ) on team_id\n| summarize teams=values(team_id), team_roles=values(roles) by user_id\n    ) on user_id\n| join kind=leftouter (\n    dataset=\"cribl_logs\" sourceType=\"access\" status=\"2*\"  \n    | summarize last_activity_at=format_datetime(max(_time), 'yy-MM-dd HH:mm') by username=tolower(user) \n    ) on username\n//| join kind=leftouter (\n//    dataset=\"cribl_logs\" sourceType=\"access\" status=\"2*\"  \n//    | summarize last_activity_at=format_datetime(max(_time), 'yy-MM-dd HH:mm') by username=tolower(user) \n//    ) on $left.email==$right.username\n| project user_id, email, username, teams, team_roles, auth_type=split(user_id,'|',0), role_updated_at, last_activity_at",
        "earliest": "-1h",
        "latest": "now"
      },
      "id": "rl06vjano",
      "layout": {
        "x": 0,
        "y": 0,
        "w": 12,
        "h": 4
      },
      "type": "list.table",
      "title": "Cribl User Audit"
    },
    {
      "config": {},
      "search": {
        "type": "inline",
        "query": "dataset=\"user_audit\" cribl_api=\"/product/{id}/users\" \n| project _time, user_id=id, email, username, roles | sort by user_id asc, _time asc                            \n| extend time_diff=datetime_diff('minute',_time,prev(_time)), job=row_cumsum(time_diff)\n| summarize job_time=format_datetime(max(_time), 'yy-MM-dd HH:mm'), all_roles=values(roles) by user_id, email, username, job\n| mv-expand all_roles | mv-expand all_roles | sort by all_roles asc | summarize roles=values(all_roles) by user_id, email, username, job_time | sort by user_id asc, job_time asc\n| extend role_updated_at=iif(prev(roles)!=roles and prev(user_id)!=user_id, job_time, prev(role_updated_at)) \n| eventstats latest_job=max(job_time) by user_id | where job_time==latest_job\n| project user_id, email, username=tolower(username), roles, role_updated_at \n| join kind=leftouter (\n    dataset=\"user_audit\" cribl_api=\"/teams/{id}/users\" \n    | project _time, user_id, team_id | sort by user_id asc, _time asc, team_id asc\n    | extend time_diff=datetime_diff('minute',_time,prev(_time)), job=row_cumsum(time_diff)\n    | summarize job_time=format_datetime(max(_time), 'yy-MM-dd HH:mm') by user_id, team_id, job\n    | eventstats latest_job=max(job_time) by user_id, team_id | where job_time==latest_job\n    | join kind=leftouter (\n        dataset=\"user_audit\" cribl_api=\"/teams\"\n        | project _time, team_id=id, roles | sort by team_id asc, _time asc\n        | extend time_diff=datetime_diff('minute',_time,prev(_time)), job=row_cumsum(time_diff)\n        | summarize job_time=format_datetime(max(_time), 'yy-MM-dd HH:mm'), roles=values(roles) by team_id, job\n        | eventstats latest_job=max(job_time) by team_id | where job_time==latest_job\n        | mv-expand roles | project team_id, roles\n        ) on team_id\n| summarize teams=values(team_id), team_roles=values(roles) by user_id\n    ) on user_id\n| join kind=leftouter (\n    dataset=\"cribl_logs\" sourceType=\"access\" status=\"2*\"  \n    | summarize last_activity_at=format_datetime(max(_time), 'yy-MM-dd HH:mm') by username=tolower(user) \n    ) on username\n//| join kind=leftouter (\n//    dataset=\"cribl_logs\" sourceType=\"access\" status=\"2*\"  \n//    | summarize last_activity_at=format_datetime(max(_time), 'yy-MM-dd HH:mm') by username=tolower(user) \n//    ) on $left.email==$right.username\n| project user_id, email, username, teams, team_roles, auth_type=split(user_id,'|',0), role_updated_at, last_activity_at | mv-expand teams",
        "earliest": "-1h",
        "latest": "now"
      },
      "id": "0z5agd4zw",
      "layout": {
        "x": 0,
        "y": 4,
        "w": 12,
        "h": 4
      },
      "type": "list.table",
      "title": "Cribl User Audit (Teams Un-Aggregated)"
    }
  ]
}